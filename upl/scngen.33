PROCEDURE SCREEN.MSK.TRX (SCREEN.NAME,SCREEN.TYPE)
BEGIN
  FIELDS
  OLD.SCREEN.TYPE SAME AS SCREEN.TYPE,
  CY AS 'C',
  CHAR.POS AS '2N',
  CHAR AS 'C',
  BEG.X.COR AS 'C',
  BEG.POS AS '2N',
  DELIMITER.SW AS 'N',
  DOLLAR.SW AS 'N',
  INQUIRY.SW AS 'N',
  LINE1 AS '80C',
  LINE2 AS '80C',
  LINE3 AS '80C',
  LINE4 AS '80C',
  LINE5 AS '80C',
  LINE6 AS '80C',
  LINE7 AS '80C',
  LINE8 AS '80C',
  LINE9 AS '80C',
  LINE10 AS '80C',
  LINE11 AS '80C',
  LINE12 AS '80C',
  LINE13 AS '80C',
  LINE14 AS '80C',
  LINE15 AS '80C',
  LINE16 AS '80C',
  LINE17 AS '80C',
  LINE18 AS '80C',
  LINE19 AS '80C',
  LINE20 AS '80C',
  LINE21 AS '80C',
  LINE22 AS '80C',
  LINE23 AS '80C'

  CONTROLS FOR RELATIONS
  CONCURRENT UPDATE

  RELATION LINE.FLDS IS
  KEY Y.COR, X.COR
  DATA FIELD.TYPE, FLD.LENGTH

  RELATION TEMP.FIELD SAME AS SCREEN.FLDS

  RELATION TEMP.MASK SAME AS SCREEN.MASK

  INCLUDE TEXT "CRT.CONTROLS"
  INCLUDE TEXT "SCREEN.INP.LIB"
  INCLUDE TEXT "PARSE.LINE"

  MOVE FUNCT.D TO FUNCT.KEY

  BUILD.MASK:
  DISPLAY SCREEN.INP USING DISPLAY.
  MASK.INPUT:
  BEGIN

    IF FUNCT.KEY EQ FUNCT.T THEN
    BEGIN
      MOVE 1 TO LINE.NO.,SPACING.
      MOVE DEFAULT TO FLD.NO, TOT.FLD.LENGTH, FLD.LENGTH, STARTING.LINE.NO.,
      ENDING.LINE.NO.,SPACE.X,DOLLAR.SW

      INPUT FRAME SCREEN.INP SENDING @27+'#'+@27+'=6o'+@27+'7'+@27+'"'

      MASK1:
      DO
      BEGIN
        TYPE TO TERMINAL SET.PROTECT.MODE.OFF,
        ERROR.LINE, ' LINE NO: ', LINE.NO.
        CONDITIONAL ON LINE.NO.
        BEGIN
          1: MOVE LINE1 TO BUF
          2: MOVE LINE2 TO BUF
          3: MOVE LINE3 TO BUF
          4: MOVE LINE4 TO BUF
          5: MOVE LINE5 TO BUF
          6: MOVE LINE6 TO BUF
          7: MOVE LINE7 TO BUF
          8: MOVE LINE8 TO BUF
          9: MOVE LINE9 TO BUF
          10: MOVE LINE10 TO BUF
          11: MOVE LINE11 TO BUF
          12: MOVE LINE12 TO BUF
          13: MOVE LINE13 TO BUF
          14: MOVE LINE14 TO BUF
          15: MOVE LINE15 TO BUF
          16: MOVE LINE16 TO BUF
          17: MOVE LINE17 TO BUF
          18: MOVE LINE18 TO BUF
          19: MOVE LINE19 TO BUF
          20: MOVE LINE20 TO BUF
          21: MOVE LINE21 TO BUF
          22: MOVE LINE22 TO BUF
          23: MOVE LINE23 TO BUF
          24: FINISH MASK.INPUT
        END

        APPLY PARSE.LINE(BUF,TEMP.FIELD)
        IF ERROR. EQ 'Y' THEN
        BEGIN
          DELETE FROM TEMP.FIELD VIA SCREEN.NAME
          DELETE FROM TEMP.MASK VIA SCREEN.NAME
          FINISH MASK1
        END
        ELSE IF LINE. NE DEFAULT THEN
        INSERT INTO TEMP.MASK
        ADD 1 TO LINE.NO.
      END
      % DO %
      WHILE LINE.NO. LE 24

    END


    ELSE IF FUNCT.KEY EQ FUNCT.Q THEN
    BEGIN
      TYPE TO TERMINAL SET.PROTECT.MODE.OFF,ERROR.LINE
      RETURN
    END

    ELSE IF FUNCT.KEY EQ FUNCT.R THEN
    TYPE TO TERMINAL CLEAR.FG.TO.SPACES, HOME

    ELSE IF FUNCT.KEY EQ FUNCT.D THEN
    BEGIN
      TYPE TO TERMINAL SET.PROTECT.MODE.OFF,CLEAR.SCREEN.TO.SPACES,
      SET.WRITE.PROTECT.ON,
      ERROR.LINE,
      34 * ' ', 'MESSAGE LINE',
      SET.WRITE.PROTECT.OFF,
      SET.PROTECT.MODE.ON,
      SET.BLOCK.MODE
      FOR EACH SCREEN.FLDS VIA SCREEN.NAME
      INSERT INTO LINE.FLDS
      MOVE DEFAULT TO CRE.DATE,CODE.DATE
      SELECT SCREENS VIA KEY THEN
      BEGIN
        MOVE CRE.DATE TO CRE.DATE OF SCREEN.MSK.TRX
        MOVE CODE.DATE TO CODE.DATE OF SCREEN.MSK.TRX
        MOVE STARTING.LINE.NO. TO STARTING.LINE.NO. OF SCREEN.MSK.TRX
        MOVE ENDING.LINE.NO. TO ENDING.LINE.NO. OF SCREEN.MSK.TRX
        MOVE SPACE.X TO SPACE.X OF SCREEN.MSK.TRX
        MOVE SCREEN.TYPE TO OLD.SCREEN.TYPE
      END
      IF SCREEN.TYPE EQ '   ' THEN
      LET SCREEN.TYPE = OLD.SCREEN.TYPE
      IF SCREEN.TYPE EQ 'INQ' OR 'FI' OR 'MSI' OR 'FMI' THEN
      LET INQUIRY.SW = 1
      LET LINE.NO. = 1
      DO
      BEGIN
        SELECT SCREEN.MASK VIA KEY THEN
        MOVE LINE. TO LINE. OF SCREEN.MSK.TRX
        ELSE MOVE DEFAULT TO LINE.
        MOVE SUBSTR(X.Y.POS,LINE.NO.,1) TO CY
        FOR EACH LINE.FLDS VIA Y.COR=CY
        BEGIN
          IF FLD.LENGTH EQ 1 AND (FIELD.TYPE NE 'E' AND 'I') THEN
          MOVE '@' TO SUBSTR(LINE.,POSITION(X.Y.POS,X.COR),1)
          ELSE
          BEGIN
            MOVE '<' TO SUBSTR(LINE.,POSITION(X.Y.POS,X.COR)-1,1)
            MOVE '>' TO SUBSTR(LINE.,POSITION(X.Y.POS,X.COR)+FLD.LENGTH,1)
          END
        END
        IF INQUIRY.SW EQ 1 AND LINE.NO. EQ STARTING.LINE.NO. THEN
        BEGIN
          LET SUBSTR(LINE.,80,1) = '$'
          IF SPACE.X NE DEFAULT THEN
          LET SUBSTR(LINE.,POSITION(X.Y.POS,SPACE.X),1) = '^'
        END
        IF LINE.NO. NE 23 THEN
        IF SCREEN.TYPE EQ 'FI' OR 'FMI' THEN
        IF LINE.NO. EQ ENDING.LINE.NO. AND LINE. EQ DEFAULT THEN
        LET SUBSTR(LINE.,80,1) = '|'

        IF LINE. NE DEFAULT THEN
        TYPE TO TERMINAL POSITION.CURSOR,CY,' ',TRIM(LINE.)
        ADD 1 TO LINE.NO.
      END
      WHILE LINE.NO. LE 23
      TYPE TO TERMINAL HOME
    END

    ELSE TYPE TO TERMINAL BELL

    INPUT FUNCTION.KEY
    IF FUNCT.KEY EQ FUNCT.D THEN
    BEGIN
      IF COUNT(LINE.FLDS) NE 0 THEN
      DELETE FROM LINE.FLDS ALL
      REPEAT BUILD.MASK
    END
    REPEAT MASK.INPUT

  END
  % MASK INPUT %


  IF SCREEN.TYPE NE OLD.SCREEN.TYPE THEN
  TYPE TO TERMINAL ERROR.LINE,BELL,
  'WARNING: SCREEN TYPE HAS CHANGED FROM ',OLD.SCREEN.TYPE,' TO ',SCREEN.TYPE,
  BELL
  PAUSE 2

  LET X.COR,Y.COR = DEFAULT
  LET STATUS. = 'CMASK'
  LET MOD.DATE = TODAY
  IF ENDING.LINE.NO. EQ DEFAULT THEN
  LET ENDING.LINE.NO. = 23
  IF SCREEN.TYPE EQ 'I/O' THEN
  LET STARTING.LINE.NO. = 1

  DELETE FROM SCREENS VIA KEY
  INSERT INTO SCREENS

  DELETE FROM SCREEN.MASK VIA SCREEN.NAME
  FOR EACH TEMP.MASK
  INSERT INTO SCREEN.MASK

  DELETE FROM SCREEN.FLDS VIA SCREEN.NAME
  FOR EACH TEMP.FIELD
  INSERT INTO SCREEN.FLDS

  DELETE FROM PRE.PROCESS VIA SCREEN.NAME
  DELETE FROM POST.PROCESS VIA SCREEN.NAME
  DELETE FROM LOOKUP VIA SCREEN.NAME
  DELETE FROM SCREEN.KEYS VIA SCREEN.NAME

END

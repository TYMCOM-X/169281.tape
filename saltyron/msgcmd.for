C MSG PROCESSOR FOR ONLINE COMMUNICATIONS.
C
        DIMENSION IA(120),IB(25),IDA1(5),ICTRL(52,15),ISTOR(18,500)
        DIMENSION ICTRF(52,15)
        DIMENSION JDA1(5),ICMD(16),MSGLOG(2,15),MSGOFF(2,15)
C
C       AT 4 CHARACTERS PER WORK IT TAKES 30 WORDS
C       PER LINE
        COMMON /RKSA/IALP(35),INUM(10),IBLK,IBLK5
        COMMON /RKSB/ISRM(15),ISM(6),IRM(6)
        DATA ILAS1,ILAS2,ISTF/0,0,0/
        DATA ICMD/5H@@Z  ,5H@@D  ,5H@@T  ,5H@@W  ,5H@@C  ,5H@@H  ,
     1            5H@@B  ,5H@@1  ,5H@@2  ,5H@@3  ,5H@@4  ,5H@@5  ,
     2            5H@@6  ,5H@@7  ,5H@@8  ,5H@@Q  /
        DATA IALP/1HA,1HB,1HC,1HD,1HE,1HF,1HG,1HH,1HI,1HJ,
     1            1HK,1HL,1HM,1HN,1HO,1HP,1HQ,1HR,1HS,1HT,
     2            1HU,1HV,1HW,1HX,1HY,1HZ,1H.,1H/,1H(,1H),
     3            1H+,1H-,1H',1H',1H;/
        DATA INUM/1H0,1H1,1H2,1H3,1H4,1H5,1H6,1H7,1H8,1H9/
        DATA IBLK,IBLK5/1H ,5H     /
        DATA ISRM/0,0,0,0,0,0,0,0,0,0,0,0,0,0,0/
C
C PULL IN CONTROL TABLE.
C
        CALL GTS(IDA1)
        TYPE 3001,IDA1
3001    FORMAT(1X,3A5,2I10)
        ILAS1=IDA1(4)
        ILAS2=IDA1(5)-1
        IF(ILAS2.LT.0)ILAS2=0
C LOAD MASTER CONTROL TABLE
C
        CALL REFCTL(ICTRL,ICTL)
1010    FORMAT(I2,8I7,1X,4A5)
1011    FORMAT(1X,I2,8I7,1X,4A5,/,1X,I2,8I7,1X,4A5)
        ICTLF=ICTL
        DO 14 I=1,ICTL
        DO 12 J=1,52
        ICTRF(J,I)=ICTRL(J,I)
12      CONTINUE
14      CONTINUE
16      CONTINUE
C
C IDENTIFY USER
C
        TYPE 3016
3016    FORMAT(' PLEASE ENTER USERID:',$)
        ACCEPT 1001,(IA(K),K=1,6)
1001    FORMAT(23A5)
        CALL UNPACK(IA,IB,30)
        CALL PACKU(IB,IA,30)
        ICTL1=ICTL+1
        DO 17 I=2,ICTL1
        IF(IA(1).NE.ICTRL(10,I))GO TO 17
        IF(IA(2).NE.ICTRL(11,I))GO TO 17
        IF(IA(3).NE.ICTRL(12,I))GO TO 17
C       IF(IA(4).NE.ICTRL(13,I))GO TO 17
C
C MATCH
C
        IUSR=I-1
C
C PASSWORD SECTION HERE IF FUTURE
C
        GO TO 18
17      CONTINUE
        GO TO 16
18      CONTINUE
        IOPTV=0
        CALL VALPAS(IUSR,ICTRL,ISNT,ISTOR,IOPTV)
        JCMD=1
        MSGLOG(1,1)=IDA1(4)
        MSGLOG(2,1)=IDA1(5)
        CALL WHOLOG(MSGLOG,MSGOFF,IUSR,JCMD)
20      CONTINUE
C       TYPE 1002,IUSR
1002    FORMAT(8I10)
C
C NOW DETERMINE WHO DO YOU WANT TO COMMUNICATE WITH
C
        ISND=0
        DO 30 I=1,ICTL
        IF(I.NE.IUSR)GO TO29
        ISM(I)=1
        IRM(I)=1
        ISRM(I)=1
        GO TO 30
29      CONTINUE
        JJ1=0
        IF(MSGLOG(1,I).GT.MSGOFF(1,I))JJ1=1
        IF(MSGLOG(1,I).GT.MSGOFF(1,I))GOTO 24
        IF(MSGLOG(1,I).LT.MSGOFF(1,I))GOTO 24
        IF(MSGLOG(2,I).GT.MSGOFF(2,I))JJ1=1
24      CONTINUE
        IF(JJ1.EQ.0)TYPE 2020,I,(ICTRL(K,I+1),K=10,13),MSGOFF(1,I),
     1  MSGOFF(2,I)
2020    FORMAT(1X,I3,1X,4A5,2I8,/,
     1  10X,' NEITHER=0, SEND=1, RECIEVE=2, BOTH=3: ',$)
2021    FORMAT(1X,I3,1X,4A5,'  is indicated as logged on',2I8,/,
     1  ' no=0, send=1, receive=2, both=3:',$)
        IF(JJ1.EQ.1)TYPE 2021,I,(ICTRL(K,I+1),K=10,13),MSGLOG(1,I),
     1  MSGLOG(2,I)
        ACCEPT 1003,IANS
1003    FORMAT(I)
        IF (IANS.LT.0)GO TO 29
        IF (IANS.GT.3)GO TO 29
        ISRM(I)=IANS
        ISM(I)=0
        IRM(I)=0
        IF(IANS.EQ.1)ISND=ISND+2**(6-I)
        IF(IANS.EQ.3)ISND=ISND+2**(6-I)
        IF(IANS.EQ.1)ISM(I)=1
        IF(IANS.EQ.2)IRM(I)=1
        IF(IANS.EQ.3)IRM(I)=1
        IF(IANS.EQ.3)ISM(I)=1
30      CONTINUE
C       TYPE 1002,ISND
C       TYPE 1201,(ISTOR(K,1),K=1,18)
C       TYPE 1201,(ISTOR(K,2),K=1,18)
1201    FORMAT(I4,8I7,9A5)
50      CONTINUE
C
C READ MESSAGE LOOP
C
        CALL GTS(IDA1)
C       TYPE 3001,IDA1
        DO 90 I=1,ICTL
        IF(I.EQ.IUSR)JDA1(1)=IDA1(4)
        IF(I.EQ.IUSR)JDA1(2)=IDA1(5)
        IF(I.EQ.IUSR)GO TO 58
        IF(ISRM(I).LT.2)GO TO 90
        IF(I.GT.4)GO TO 52
        IF(I.EQ.1)JDA1(1)=ISTOR(2,1)
        IF(I.EQ.1)JDA1(2)=ISTOR(3,1)
        IF(I.EQ.2)JDA1(1)=ISTOR(4,1)
        IF(I.EQ.2)JDA1(2)=ISTOR(5,1)
        IF(I.EQ.3)JDA1(1)=ISTOR(6,1)
        IF(I.EQ.3)JDA1(2)=ISTOR(7,1)
        IF(I.EQ.4)JDA1(1)=ISTOR(8,1)
        IF(I.EQ.4)JDA1(2)=ISTOR(9,1)
        GO TO 56
52      CONTINUE
        IF(I.EQ.5)JDA1(1)=ISTOR(2,2)
        IF(I.EQ.5)JDA1(2)=ISTOR(3,2)
        IF(I.EQ.6)JDA1(1)=ISTOR(4,2)
        IF(I.EQ.6)JDA1(2)=ISTOR(5,2)
        IF(I.EQ.7)JDA1(1)=ISTOR(6,2)
        IF(I.EQ.7)JDA1(2)=ISTOR(7,2)
        IF(I.EQ.8)JDA1(1)=ISTOR(8,2)
        IF(I.EQ.8)JDA1(2)=ISTOR(9,2)
56      CONTINUE
        L=I
        CALL RDMSGU(IUSR,L,JDA1,ICTRL,ICTL,IEC)
        IF(IEC.NE.0)GO TO 90
58      CONTINUE
        IF(I.EQ.1)ISTOR(2,1)=JDA1(1)
        IF(I.EQ.1)ISTOR(3,1)=JDA1(2)
        IF(I.EQ.2)ISTOR(4,1)=JDA1(1)
        IF(I.EQ.2)ISTOR(5,1)=JDA1(2)
        IF(I.EQ.3)ISTOR(6,1)=JDA1(1)
        IF(I.EQ.3)ISTOR(7,1)=JDA1(2)
        IF(I.EQ.4)ISTOR(8,1)=JDA1(1)
        IF(I.EQ.4)ISTOR(9,1)=JDA1(2)
        IF(I.EQ.5)ISTOR(2,2)=JDA1(1)
        IF(I.EQ.5)ISTOR(3,2)=JDA1(2)
        IF(I.EQ.6)ISTOR(4,2)=JDA1(1)
        IF(I.EQ.6)ISTOR(5,2)=JDA1(2)
        IF(I.EQ.7)ISTOR(6,2)=JDA1(1)
        IF(I.EQ.7)ISTOR(7,2)=JDA1(2)
        IF(I.EQ.8)ISTOR(8,2)=JDA1(1)
        IF(I.EQ.8)ISTOR(9,2)=JDA1(2)
90      CONTINUE
C       TYPE 1201,(ISTOR(K,1),K=1,18)
C       TYPE 1201,(ISTOR(K,2),K=1,18)
C
C SEND MESSAGE LOOP
C
91      CONTINUE
        TYPE 9010
9010    FORMAT(' MSG>',$)
        ACCEPT 9011,(IA(K),K=1,22)
9011    FORMAT(23A5)
        DO 92 J=1,22
        JL=23-J
        IF(IA(JL).EQ.IBLK5)GO TO 92
        GO TO 94
92      CONTINUE
C
C NULL LINE
C
        GO TO 50
94      CONTINUE
C
C SEE IF COMMAND
C
        CALL UNPACK(IA,IB,3)
        IB(4)=IBLK
        IB(5)=IBLK
        CALL PACKU(IB,IB,7)
        IANS=IB(1)
C
C TEST HERE ON COMMAND
C SOMETIME IN FUTURE
C
        IF(IANS.EQ.ICMD(1))ISTF=1
        IF(IANS.EQ.ICMD(1))GO TO 101
        IF(IANS.EQ.ICMD(16))ISTF=1
        IF(IANS.EQ.ICMD(16))GOTO 101
        IF(IANS.EQ.ICMD(4))CALL WHOLOG(MSGLOG,MSGOFF,IUSR,3)
        IF(IANS.EQ.ICMD(4))GOTO 91
        IF(IANS.EQ.ICMD(5))GOTO 20
        IF(IANS.EQ.ICMD(6))TYPE 3099
        IF(IANS.EQ.ICMD(6))TYPE 3999
        IF(IANS.EQ.ICMD(6))GOTO 91
3099    FORMAT(' VALID COMMANDS ARE LEFT JUSTIFIED AND ARE:',/,
     1  ' @@B   - ENTER AND EXIT BLOCK MODE',/,
     2  ' @@C   - CHANGE SEND RECEIVE LIST',/,
     3  ' @@H   - PRINT THIS LIST',/,
     4  ' @@W   - LIST OUT WHO IS THOUGHT TO BE ON THE SYSTEM',/,
     7  ' @@Z   - END SESSION')
3999    FORMAT(' ',/,
     1  ' @@n MSG - Where n is a number from 1 to 6 representing ',/,
     2  '         the user number and MSG is the immediate message',/,
     3  ' ')
        IF(IANS.EQ.ICMD(7))GOTO 150
        IF(IANS.EQ.ICMD(8))GOTO 180
        IF(IANS.EQ.ICMD(9))GOTO 180
        IF(IANS.EQ.ICMD(10))GOTO 180
        IF(IANS.EQ.ICMD(11))GOTO 180
        IF(IANS.EQ.ICMD(12))GOTO 180
        IF(IANS.EQ.ICMD(13))GOTO 180
        IF(IANS.EQ.ICMD(14))GOTO 180
        IF(IANS.EQ.ICMD(15))GOTO 180
100     CONTINUE
        ISNT=ISNT+1
        ISTOR(1,ISNT)=ISND
101     CONTINUE
        CALL GTS(IDA1)
        IF(IDA1(4).NE.ILAS1)GO TO 102
        IF(IDA1(5).LE.ILAS2)IDA1(5)=ILAS2+1
102     CONTINUE
        IF(ISTF.EQ.1)GO TO 120
        ISTOR(2,ISNT)=IDA1(4)
        ISTOR(3,ISNT)=IDA1(5)
        DO 110 I=1,15
        ISTOR(3+I,ISNT)=IA(I)
        ISTOR(3+I,ISNT+1)=IBLK5
110     CONTINUE
        IF(JL.LE.15)GO TO 120
        ISNT=ISNT+1
        IDA1(5)=IDA1(5)+1
        ISTOR(3,ISNT)=IDA1(5)
        ISTOR(2,ISNT)=IDA1(4)
        ISTOR(1,ISNT)=ISND
        DO 115 I=16,JL
        ISTOR(I-12,ISNT)=IA(I)
115     CONTINUE
120     CONTINUE
        ILAS1=IDA1(4)
        ILAS2=IDA1(5)
        DO 130 J=1,ICTL
        IF(ISM(J).EQ.0)GO TO 130
C
C STORE WRITE INFO INTO CORRECT CELLS
C
        J1=3
        IF(J.GT.4)J1=4
        J2=2*J
        IF(J.GT.4)J2=J2-8
        ISTOR(J2,J1)=IDA1(4)
        ISTOR(J2+1,J1)=IDA1(5)
130     CONTINUE
        CALL WRIST(ISTOR,ISNT,ICTRL,ICTL,IUSR)
        IF(ISTF.EQ.1)GO TO 900
        GO TO 50
150     CONTINUE
C
C BLOCK MODE FOR TRANSFERS FROM A WORD PROCESSOR
C
C KEYED BY THE APPEARANCE OF @@B AS AND END OF BLOCK
C
        TYPE 3150
3150    FORMAT(' BEGIN BLOCK TRANSFER -- WHEN FINISHED TYPE',/,
     1  ' <CR>@@B<CR>',/)
160     CONTINUE
        ACCEPT 1001,(IA(K),K=1,22)
        CALL UNPACK(IA,IB,3)
        IB(4)=IBLK
        IB(5)=IBLK
        CALL PACKU(IB,IANS,5)
        IF(IANS.EQ.ICMD(7))GOTO 120
        DO 161 I=1,22
        KJL=23-I
        IF (IA(KJL).NE.IBLK5)GO TO 163
161     CONTINUE
        GO TO 160
163     CONTINUE
        ISNT=ISNT+1
        IF(ISNT.GT.499)GO TO 170
        ISTOR(1,ISNT)=ISND
        CALL GTS(IDA1)
        IF(IDA1(4).NE.ILAS1)GO TO 162
        IF(IDA1(5).LT.ILAS2)IDA1(5)=ILAS2+1
        ISTOR(2,ISNT)=IDA1(4)
        ISTOR(3,ISNT)=IDA1(5)
162     ILAS1=IDA1(4)
        ILAS2=IDA1(5)
        DO 168 J=4,18
        ISTOR(J,ISNT)=IA(J-3)
        ISTOR(J,ISNT+1)=IBLK5
168     CONTINUE
C       TYPE 3168,(ISTOR(K,ISNT),K=1,18)
3168    FORMAT(I3,2I7,1X,20A5)
        IF(KJL.LE.15)GO TO 160
        ISNT=ISNT+1
        ISTOR(1,ISNT)=ISTOR(1,ISNT-1)
        ISTOR(2,ISNT)=ISTOR(2,ISNT-1)
        ISTOR(3,ISNT)=ISTOR(3,ISNT-1)+1
        ISTOR(4,ISNT)=IA(16)
        ISTOR(5,ISNT)=IA(17)
        ISTOR(6,ISNT)=IA(18)
        ISTOR(7,ISNT)=IA(19)
        ISTOR(8,ISNT)=IA(20)
        ISTOR(9,ISNT)=IA(21)
        ISTOR(10,ISNT)=IA(22)
        ILAS2=ILAS2+1
        GO TO 160
170     CONTINUE
        TYPE 3170,ISNT
3170    FORMAT(' NUMBER (',I5,' ) OF ENTRIES IN TABLE EXCEEDS 500')
        GOTO 160
180     CONTINUE
C
C DIRECT SEND IRRESPECTIVE OF WHO
C
        ISND1=0
        IF(ISNT.GE.500)GO TO  50
        IF(IANS.EQ.ICMD(8))ISND1=32
        IF(IANS.EQ.ICMD(9))ISND1=16
        IF(IANS.EQ.ICMD(10))ISND1=8
        IF(IANS.EQ.ICMD(11))ISND1=4
        IF(IANS.EQ.ICMD(12))ISND1=2
        IF(IANS.EQ.ICMD(13))ISND1=1
        IF(IANS.EQ.ICMD(14))ISND1=0
        IF(IANS.EQ.ICMD(15))ISND1=0
        IF(ISND1.EQ.0)GOTO  100
        ISNT=ISNT+1
        ISTOR(1,ISNT)=ISND1
        GO TO 101
800     CONTINUE
C
C RETURN TIME BACK TO START OR SOMEWHERE IN BETWEEN
C
900     CONTINUE
C
C WRITE OUT MASTER RECORD
C
        CLOSE(UNIT=26)
        OPEN(UNIT=26,ACCESS='SEQIN',FILE='MSG.CTL',ERR=910)
        READ(26,9001,END=920)(ICTRL(K,1),K=1,13)
9001    FORMAT(I2,8I7,1X,4A5)
9002    FORMAT(I2,8I7,1X,4A5,'*')
        ICHK=ICTRL(1,1)
        DO 905 J=1,ICHK
        ICNT=J+1
        READ(26,9001,END=920)(ICTRL(K,ICNT),K=1,13)
        READ(26,9001,END=920)(ICTRL(K,ICNT),K=14,26)
        READ(26,9001,END=920)(ICTRL(K,ICNT),K=27,39)
        READ(26,9001,END=920)(ICTRL(K,ICNT),K=40,52)
        IF(ICTRL(1,ICNT).NE.IUSR)GO TO 905
        DO 904 L=1,9
        ICTRL(L,ICNT)=ISTOR(L,1)
        ICTRL(L+13,ICNT)=ISTOR(L,2)
        ICTRL(L+26,ICNT)=ISTOR(L,3)
        ICTRL(L+39,ICNT)=ISTOR(L,4)
904     CONTINUE
905     CONTINUE
        CLOSE(UNIT=26)
        OPEN(UNIT=26,ACCESS='SEQOUT',FILE='MSG.CTL',ERR=910)
        WRITE(26,9002)(ICTRL(K,1),K=1,13)
        DO 908 I=2,ICNT
        WRITE(26,9002)(ICTRL(K,I),K=1,13)
        WRITE(26,9002)(ICTRL(K,I),K=14,26)
        WRITE(26,9002)(ICTRL(K,I),K=27,39)
        WRITE(26,9002)(ICTRL(K,I),K=40,52)
908     CONTINUE
        JCMD=2
        MSGLOG(1,1)=IDA1(4)
        MSGLOG(2,1)=IDA1(5)
        CALL WHOLOG(MSGLOG,MSGOFF,IUSR,JCMD)
        CALL EXIT
910     CONTINUE
        TYPE 3910
3910    FORMAT(' MASTER CONTROL FILE: (SALTYRON)MSG.CTL NOT AVAILABLE')
        CALL EXIT
920     CONTINUE
        TYPE 3920
3920    FORMAT(' MASTER CONTROL FILE ERROR:(SALTYRON)MSG.CTL')
        CALL EXIT
        END
  